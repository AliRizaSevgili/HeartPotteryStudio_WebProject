<!-- Stepper/Progress Bar -->
<section aria-label="Checkout Progress" class="w-full">
  <div class="w-full max-w-2xl mx-auto flex justify-between items-center mt-40 mb-12">
    <div class="flex-1 flex flex-col items-center">
      <button id="step-cart-btn" type="button" class="focus:outline-none">
        <div id="step-cart" class="step-circle w-8 h-8 rounded-full bg-indigo-500 text-white font-bold">1</div>
      </button>
      <span class="mt-2 text-sm font-semibold text-indigo-700">Cart</span>
      <!-- Hata Kutucuğu -->
      <div id="cart-error" class="hidden bg-red-100 text-red-700 p-2 rounded mt-2 text-sm max-w-xs text-center">
        Please complete the Cart section before proceeding.
      </div>
    </div>
    <div class="flex-1 border-t-2 border-indigo-300 mx-2"></div>
    <div class="flex-1 flex flex-col items-center">
      <button id="step-delivery-btn" type="button" class="focus:outline-none">
        <div id="step-delivery" class="step-circle w-8 h-8 rounded-full bg-gray-200 text-gray-700 font-bold">2</div>
      </button>
      <span class="mt-2 text-sm font-semibold text-gray-700">Info</span>
      <!-- Hata Kutucuğu -->
      <div id="delivery-error" class="hidden bg-red-100 text-red-700 p-2 rounded mt-2 text-sm max-w-xs text-center">
        Please complete the Info section before proceeding.
      </div>
    </div>
  </div>
</section>

<!-- Error Message Container -->
<div id="progress-error" class="hidden bg-red-100 text-red-700 p-3 rounded mb-4 max-w-2xl mx-auto text-center opacity-0 pointer-events-none"></div>

<!-- Cart Section -->
<section>
  <div id="cart-section" class="container mx-auto mt-10">
    <div class="sm:flex shadow-md my-10">
      <div class="w-full sm:w-3/4 bg-white px-10 py-10">
        <div class="flex justify-between border-b pb-8">
          <h1 class="font-semibold text-2xl">Cart</h1>
          <h2 class="font-semibold text-2xl">
            {{#if cart.length}}
              {{cart.length}} Items
            {{else}}
              0 Items
            {{/if}}
          </h2>
        </div>
        {{#if selectedClass}}
        <!-- Seçilen slot ve class bilgileri -->
        <div class="md:flex items-stretch py-8 md:py-10 lg:py-8 border-t border-gray-50">
          <div class="md:w-4/12 2xl:w-1/4 w-full">
            <img src="{{selectedClass.image}}" alt="{{selectedClass.title}}" class="h-full object-center object-cover rounded-lg" />
          </div>
          <div class="md:pl-3 md:w-8/12 2xl:w-3/4 flex flex-col justify-center">
            <p class="text-base font-bold text-gray-800 mb-2">{{selectedClass.title}}</p>
            <p class="text-sm text-gray-600 mb-1"><strong>Day:</strong> {{selectedClass.slotDay}}</p>
            <p class="text-sm text-gray-600 mb-1"><strong>Date:</strong> {{selectedClass.slotDate}}</p>
            <p class="text-sm text-gray-600 mb-1"><strong>Time:</strong> {{selectedClass.slotTime}}</p>
            <div class="flex items-center justify-between pt-5">
              <div class="flex items-center">
                <p class="text-xs leading-3 underline text-gray-800 cursor-pointer">Add to favorites</p>
                <p class="text-xs leading-3 underline text-red-500 pl-5 cursor-pointer">Remove</p>
              </div>
              <p class="text-base font-black leading-none text-gray-800">{{selectedClass.price}}</p>
            </div>
          </div>
        </div>
        {{else}}
        <!-- Demo ürünler -->
        {{#if cart.length}}
          {{#each cart}}
            <div class="md:flex items-stretch py-8 md:py-10 lg:py-8 border-t border-gray-50">
              <div class="md:w-4/12 2xl:w-1/4 w-full">
                <img src="{{classImage}}" alt="{{classTitle}}" 
                     class="w-full h-auto object-center object-contain rounded-lg" />
              </div>
              <div class="md:pl-3 md:w-8/12 2xl:w-3/4 flex flex-col justify-center">
                <p class="text-base font-bold text-gray-800 mb-2">{{classTitle}}</p>
                <p class="text-sm text-gray-600 mb-1"><strong>Day:</strong> {{slotDay}}</p>
                <p class="text-sm text-gray-600 mb-1"><strong>Date:</strong> {{slotDate}}</p>
                <p class="text-sm text-gray-600 mb-1"><strong>Time:</strong> {{slotTime}}</p>
                <div class="flex items-center justify-between pt-5">
                  <p class="text-base font-black leading-none text-gray-800">{{classPrice}}</p>
                  <form method="POST" action="/remove-from-cart" class="ml-4">
                    <input type="hidden" name="classId" value="{{classId}}">
                    <input type="hidden" name="slotDay" value="{{slotDay}}">
                    <input type="hidden" name="slotDate" value="{{slotDate}}">
                    <input type="hidden" name="slotTime" value="{{slotTime}}">
                    <button type="submit" class="text-xs leading-3 underline text-red-500 cursor-pointer hover:text-red-700 transition">
                      Remove
                    </button>
                  </form>
                </div>
              </div>
            </div>
          {{/each}}
        {{else}}
          <p>Your cart is empty.</p>
        {{/if}}

        <a href="#" onclick="window.history.length > 1 ? history.back() : window.location.href='/learn'" class="flex font-semibold text-indigo-600 text-sm mt-10 transition-all duration-150 hover:text-indigo-800 hover:text-base">
          <svg class="fill-current mr-2 text-indigo-600 w-4" viewBox="0 0 448 512">
            <path d="M134.059 296H436c6.627 0 12-5.373 12-12v-56c0-6.627-5.373-12-12-12H134.059v-46.059c0-21.382-25.851-32.09-40.971-16.971L7.029 239.029c-9.373 9.373-9.373 24.569 0 33.941l86.059 86.059c15.119 15.119 40.971 4.411 40.971-16.971V296z"/>
          </svg>
          Continue Shopping
        </a>
        {{/if}}
      </div>
      <div id="summary" class="w-full sm:w-1/4 md:w-1/2 px-8 py-10">
        <h1 class="font-semibold text-2xl border-b pb-8">Order Summary</h1>
        <div class="mt-8 mb-5">
          <!-- Order Summary -->
          <ul class="divide-y divide-gray-200">
            {{#each cart}}
              <li class="flex justify-between py-2">
                <span class="text-sm text-gray-700">{{classTitle}} ({{slotDate}} {{slotTime}})</span>
                <span class="text-sm font-semibold text-gray-900">{{classPrice}}</span>
              </li>
            {{/each}}
          </ul>
        </div>
        <div class="flex justify-between mt-10 mb-5">
          <span class="font-semibold text-sm uppercase">
            {{#if cart.length}}
              Items {{cart.length}}
            {{else}}
              Items 0
            {{/if}}
          </span>
          <span class="font-semibold text-sm">
            {{#if cart.length}}
              ${{sum cart "classPrice"}}
            {{else}}
              $0
            {{/if}}
          </span>
        </div>
        <form method="POST" action="/apply-promo" class="mb-2">
          <label for="promo" class="font-semibold inline-block mb-3 text-sm uppercase">
            Promo Code
          </label>
          <input
            type="text"
            id="promo"
            name="promo"
            placeholder="Enter your code"
            class="p-2 text-sm w-full"
          />
          <button class="bg-red-500 hover:bg-red-600 px-5 py-2 text-sm text-white uppercase mt-2" type="submit">
            Apply
          </button>
        </form>
        {{#if promoMessage}}
          <div class="text-xs text-indigo-700 mb-2">{{promoMessage}}</div>
        {{/if}}
        <div class="border-t mt-8">
          <div class="space-y-1 mb-4 mt-4">
            <div class="flex justify-between text-sm text-gray-700">
              <span>Subtotal</span>
              <span>
                {{#if cart.length}}
                  ${{sum cart "classPrice"}}
                {{else}}
                  $0
                {{/if}}
              </span>
            </div>
            <div class="flex justify-between text-sm text-gray-700">
              <span>Savings</span>
              <span>
                {{#if promo}}
                  -${{discountAmount cart promo.discount}}
                {{else}}
                  $0
                {{/if}}
              </span>
            </div>
            <!-- Canada GST satırı kaldırıldı -->
            <div class="flex justify-between text-sm text-gray-700">
              <span>Tax (HST 13%)</span>
              <span>
                ${{taxAmount cart 0.13}}
              </span>
            </div>
          </div>
          <div class="flex font-semibold justify-between py-6 text-sm uppercase">
            <span>Total cost</span>
            <span>
              {{#if promo}}
                ${{totalCost cart promo.discount 0.13}}
              {{else}}
                ${{totalCost cart 0 0.13}}
              {{/if}}
            </span>
          </div>
          <button id="go-to-delivery" class="bg-indigo-500 font-semibold hover:bg-indigo-600 py-3 text-sm text-white uppercase w-full">
            Checkout
          </button>
        </div>
      </div>
    </div>
  </div>
</section>




<!-- Delivery Details Section (başlangıçta gizli) -->
<section id="delivery-section" class="bg-white py-8 antialiased dark:bg-gray-900 md:py-16 hidden" style="margin-top:-80px;">
  <!-- Form -->
  <!-- Formlarda CSRF tokeni -->
  <form id="checkout-info-form" action="/checkout-info" method="POST" class="mx-auto mt-4 max-w-xl sm:mt-6">
    <input type="hidden" name="_csrf" id="csrfToken" value="{{csrfToken}}">
    <div class="grid grid-cols-1 gap-x-12 gap-y-6 sm:grid-cols-2">
      <!-- First Name -->
      <div>
        <label for="firstName" class="block text-sm/6 font-semibold text-gray-500">First name</label>
        <div class="mt-2.5">
          <input
            type="text"
            name="firstName"
            id="firstName"
            placeholder="Enter your first name"
            autocomplete="given-name"
            required
            class="block w-full rounded-md bg-white px-3.5 py-2 text-base text-gray-700 border border-gray-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-pink-100 shadow-none appearance-none placeholder:text-gray-400 placeholder:text-sm transition-all duration-200"
          />
        </div>
        <p class="hidden text-pink-500 text-sm mt-1"></p> <!-- Hata mesajı -->
      </div>
      <!-- Last Name -->
      <div>
        <label for="lastName" class="block text-sm/6 font-semibold text-gray-500">Last name</label>
        <div class="mt-2.5">
          <input
            type="text"
            name="lastName"
            id="lastName"
            placeholder="Enter your last name"
            autocomplete="family-name"
            required
            class="block w-full rounded-md bg-white px-3.5 py-2 text-base text-gray-700 border border-gray-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-pink-100 shadow-none appearance-none placeholder:text-gray-400 placeholder:text-sm transition-all duration-200"
          />
        </div>
        <p class="hidden text-pink-500 text-sm mt-1"></p> <!-- Hata mesajı -->
      </div>
      <!-- Company -->
      <div class="sm:col-span-2">
        <label for="company" class="block text-sm/6 font-semibold text-gray-500">Company <span class="text-gray-400 font-normal">(optional)</span></label>
        <div class="mt-2.5">
          <input
            type="text"
            name="company"
            id="company"
            placeholder="Enter your company"
            autocomplete="organization"
            class="block w-full rounded-md bg-white px-3.5 py-2 text-base text-gray-700 border border-gray-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-pink-100 shadow-none appearance-none placeholder:text-gray-400 placeholder:text-sm transition-all duration-200"
          />
        </div>
      </div>
      <!-- Phone Number -->
      <div>
        <label for="contactNumber" class="block text-sm/6 font-semibold text-gray-500">Phone Number</label>
        <div class="relative mt-2.5">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-slate-600">
              <path fill-rule="evenodd" d="M1.5 4.5a3 3 0 0 1 3-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 0 1-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 0 0 6.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 0 1 1.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 0 1-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5Z" clip-rule="evenodd" />
          </div>
          <input
            id="contactNumber"
            name="contactNumber"
            type="tel"
            placeholder="e.g., +1 123-456-7890"
            class="peer w-full bg-transparent placeholder:text-slate-400 text-gray-700 text-sm border border-gray-300 rounded-md pr-3 pl-10 py-2 focus:outline-none focus:border-transparent focus:ring-2 focus:ring-pink-100 shadow-none appearance-none transition duration-200 ease-in-out"
            pattern="^\+\d{1,3}\s\d{1,3}-\d{3}-\d{4}$"
            title="Phone number must be in the format: +1 123-456-7890"
            maxlength="16"
            required
          />
        </div>
        <p class="hidden text-pink-500 text-sm mt-1"></p> <!-- Hata mesajı -->
      </div>
      <!-- Email -->
      <div>
        <label for="email" class="block text-sm/6 font-semibold text-gray-500">Email</label>
        <div class="mt-2.5">
          <input
            type="email"
            name="email"
            id="email"
            placeholder="Enter your email"
            autocomplete="email"
            required
            class="block w-full rounded-md bg-white px-3.5 py-2 text-base text-gray-700 border border-gray-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-pink-100 shadow-none appearance-none placeholder:text-gray-400 placeholder:text-sm transition-all duration-200"
          />
        </div>
        <p class="hidden text-pink-500 text-sm mt-1"></p> <!-- Hata mesajı -->
      </div>
      <!-- Address -->
      <div class="sm:col-span-2">
        <label for="address" class="block text-sm/6 font-semibold text-gray-500">Address</label>
        <div class="mt-2.5">
          <input
            type="text"
            name="address"
            id="address"
            placeholder="Enter your address"
            autocomplete="street-address"
            required
            class="block w-full rounded-md bg-white px-3.5 py-2 text-base text-gray-700 border border-gray-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-pink-100 shadow-none appearance-none placeholder:text-gray-400 placeholder:text-sm transition-all duration-200"
          />
        </div>
        <p class="hidden text-pink-500 text-sm mt-1"></p> <!-- Hata mesajı -->
      </div>
      <!-- Toggle -->
      <div class="flex gap-x-4 sm:col-span-2 mt-6">
        <label class="inline-flex items-center cursor-pointer">
          <!-- Gizli checkbox (peer) -->
          <input type="checkbox" class="sr-only peer" id="toggle-agreement" />

          <!-- Toggle çubuğu -->
          <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-pink-100 rounded-full 
                      peer-checked:after:translate-x-full 
                      rtl:peer-checked:after:-translate-x-full
                      peer-checked:after:border-white 
                      after:content-[''] after:absolute after:top-[2px] after:start-[2px] 
                      after:bg-white after:border-gray-300 after:border 
                      after:rounded-full after:h-5 after:w-5 after:transition-all 
                      peer-checked:bg-pink-200">
          </div>

          <!-- Açıklama metni -->
          <span class="ms-3 text-sm font-medium text-gray-700" id="switch-1-label">
            By selecting this, you agree to our
            <a href="#" class="font-semibold text-pink-400 hover:text-pink-500">privacy&nbsp;policy</a>.
          </span>
        </label>

        <!-- ❗ Hata mesajı -->
        <p id="toggle-error" class="mt-2 text-sm text-pink-500 hidden">
          Please agree to the privacy policy.
        </p>
      </div>
      <div class="mt-10 flex w-full">
        <div class="mx-auto flex gap-4" style="width:340px;">
          <button
            type="button"
            id="back-to-cart"
            class="rounded-md bg-white px-3 py-2 text-center text-base font-semibold text-gray-700 border border-gray-300 shadow-none hover:bg-gray-100 focus:outline-none focus:ring-0 transition-all duration-200"
            style="min-width:120px;"
          >
            Back to Cart
          </button>
          <form action="/create-checkout-session" method="POST" style="min-width:160px;">
            <input type="hidden" name="email" value="{{email}}">
            <button
              type="submit"
              id="pay-now-btn"
              class="rounded-md bg-[#f8dce2] px-3.5 py-2.5 text-center text-base font-semibold text-[#5a3a3c] shadow-none hover:bg-[#f4cdd7] focus:outline-none focus:ring-0 border-none transition-all duration-200"
              style="min-width:160px;"
            >
              Pay now
            </button>
          </form>
        </div>
      </div>
      <!-- Add this hidden input inside your form -->
      <input type="hidden" name="recaptchaToken" id="recaptchaToken">
    </div>
  </form>
</section>

<script src="/js/checkout_steps.js"></script>
<script src="https://www.google.com/recaptcha/api.js?render=6Lfk1X0rAAAAABIekRWzhhzOs9yqkXroGTCmhmmI"></script>